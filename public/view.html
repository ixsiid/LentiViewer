<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            border: none;
        }

        html,
        body,
        #content {
            width: 100%;
            height: 100%;
        }

        #navi {
            position: fixed;
            bottom: 0.3em;
            left: 0;
            width: 100%;
            text-align: right;
            vertical-align: middle;
            color: white;
            font-weight: bold;
        }

    </style>

    <script src="util/switch.js"></script>

    <script src="three/three.min.js"></script>
    <script src="three/mmdparser.min.js"></script>
    <script src="three/TGALoader.js"></script>
    <script src="three/ammo.js"></script>
    <script src="three/CCDIKSolver.js"></script>
    <script src="three/MMDPhysics.js"></script>
    <script src="three/MMDLoader.js"></script>
    <script src="three/MMDAnimationHelper.js"></script>

    <script type="module">
        import { quat, mat4, vec3 } from './util/gl-matrix/src/index.js';
        import PlaneFactory from './lenti_mask/renderer/plane.js';

        import Lenti from './lenti_mask/index.js';

        var renderer, scene, clock;
        var lenti, helper;
        const game = {};
        const items = [];

        function update() {
            items.map(x => x.rotation.y += 0.01);

            renderer.clear(true, true, false);

            helper.update(clock.getDelta());
            lenti.render(scene);

            requestAnimationFrame(update);
        }


        window.addEventListener('load', async () => {
            const content = document.querySelector('#content');
            const { width, height } = (() => {
                const bounds = content.getClientRects()[0];
                return { width: bounds.width, height: bounds.height };
            })();

            renderer = new THREE.WebGLRenderer({
                canvas: content,
                preserveDrawingBuffer: true,
            });
            renderer.autoClear = false;
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(width, height);

            const lens = {
                SlantAngleDegrees: 76.95,
                ViewCount: 27,
                DPL: 7.59375
            };
            const camera = {
                Distance: 1000,
                AngleOfViewDegrees: 45,  // １つのカメラの画角
                Aspect: width / height,
                ViewingAngleDegrees: 60, // 観察者の視野角
            } 

            lenti = new Lenti(renderer, lens, camera);

            scene = new THREE.Scene();

            const light = new THREE.AmbientLight(0xa0a0a0); // soft white light
            scene.add(light);

            const useMMD = true;

            if (useMMD) {
                const model = 'mmd/model/picachu_dance_v2.pmx';
                const anime = 'mmd/motion/dramatsurugi.vmd';

                helper = new THREE.MMDAnimationHelper();
                const loader = new THREE.MMDLoader();
                loader.loadWithAnimation(model, anime,
                    mmd => {
                        helper.add(mmd.mesh, {
                            animation: mmd.animation,
                            physics: false,
                        });
                        scene.add(mmd.mesh);
                    },
                    xhr => console.log((xhr.loaded / xhr.total * 100) + '% loaded'),
                    xhr => console.log('An error happened')
                );
            } else {
                const geometry = new THREE.BoxGeometry(200, 200, 200);
                const material = new THREE.MeshNormalMaterial();
                const box = new THREE.Mesh(geometry, material);
                box.rotation.x += 0.5;
                scene.add(box);

                items.push(box);
            }

            clock = new THREE.Clock();
            clock.start();
            update();
        }, false);
    </script>
</head>

<body>
    <p id="navi"><a href="app.html">App</a></p>
    <canvas id="content"></canvas>
</body>

</html>
